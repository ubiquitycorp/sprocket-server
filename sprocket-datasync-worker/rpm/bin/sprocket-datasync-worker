#!/bin/sh
FREE=/usr/bin/free
AWK=/bin/awk
GREP=/bin/grep
JAVA=/usr/bin/java

SPROCKET_WORKER_CFG=/etc/sysconfig/sprocket-worker

AVAILMEM=`$FREE -m | $GREP Mem | $AWK '{print $2}'`
SPROCKET_SMALL=1024
SPROCKET_LARGE=2048
SPROCKET_WORKER_MINFREE=4095
SPROCKET_WORKER_NAME=/var/lib/java-services/sprocket-datasync-worker.jar
NUM_PROCESSES=${datasync.worker.processes}
if [ ! "${NUM_PROCESSES}" ]
then
 NUM_PROCESSES=1
fi

[ -f $SPROCKET_WORKER_CFG ] && source $SPROCKET_WORKER_CFG

SPROCKET_WORKER_SIZE=$SPROCKET_SMALL

if [ $AVAILMEM -gt $SPROCKET_WORKER_MINFREE ]
then
 SPROCKET_WORKER_SIZE=$SPROCKET_LARGE
fi

SPROCKET_WORKER_INDIVIDUAL=${datasync.worker.size}
if [ ! "$SPROCKET_WORKER_INDIVIDUAL" ]
then
 SPROCKET_WORKER_INDIVIDUAL=`expr ${SPROCKET_WORKER_SIZE} / ${NUM_PROCESSES}`
fi

echo "Available Memory: ${AVAILMEM}MB"
echo "Running ${NUM_PROCESSES} workers each ${SPROCKET_WORKER_INDIVIDUAL}MB."
while [ $NUM_PROCESSES -gt 0 ]
do
 echo "Launching worker ${NUM_PROCESSES} at `date`"
 $JAVA -Xmx${SPROCKET_WORKER_INDIVIDUAL}m -cp ${SPROCKET_WORKER_NAME} com.ubiquity.sprocket.datasync.worker.DataSyncWorker &
 NUM_PROCESSES=`expr ${NUM_PROCESSES} - 1`
done
