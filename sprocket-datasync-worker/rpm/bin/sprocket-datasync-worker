#!/bin/sh
FREE=/usr/bin/free
AWK=/bin/awk
GREP=/bin/grep
JAVA=/usr/bin/java

SPROCKET_WORKER_CFG=/etc/sysconfig/sprocket-worker

AVAILMEM=`$FREE -m | $GREP Mem | $AWK '{print $4}'`
SPROCKET_WORKER_SIZE=1024
SPROCKET_WORKER_MINFREE=`expr $SPROCKET_WORKER_SIZE + $SPROCKET_WORKER_SIZE`
SPROCKET_WORKER_NAME=/var/lib/java-services/sprocket-datasync-worker.jar

[ -f $SPROCKET_WORKER_CFG ] && source $SPROCKET_WORKER_CFG

echo "Available Memory: ${AVAILMEM}MB"
echo "Sprocket Worker Size: ${SPROCKET_WORKER_SIZE}MB"

if [ $SPROCKET_WORKER_MINFREE -lt $AVAILMEM ]
then
 echo "${SPROCKET_WORKER_MINFREE}MB is less than ${AVAILMEM}MB, launching $SPROCKET_WORKER_NAME."
 $JAVA -Xmx${SPROCKET_WORKER_SIZE}m -jar ${SPROCKET_WORKER_NAME}
 exit 0
else
 echo "$SPROCKET_WORKER_MINFREE is not less than $AVAILMEM, not launching $SPROCKET_WORKER_NAME."
 exit 1
fi
